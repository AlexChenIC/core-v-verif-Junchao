# CV32E40P快速上手实战指南 ⚡

> **30分钟从环境配置到跑出第一个自定义测试**  
> 面向有UVM基础、想立即开始使用CV32E40P平台的工程师

---

## 🎯 本指南目标

- ✅ **10分钟**: 完成环境配置和依赖检查
- ✅ **10分钟**: 验证平台正常运行  
- ✅ **10分钟**: 创建并运行第一个自定义测试

---

## ⚡ 第一步：环境配置速成 (10分钟)

### 🔧 核心环境变量一键配置

创建环境配置脚本 `setup_cv32e40p.sh`：

```bash
#!/bin/bash
# CV32E40P环境配置脚本

# 🔹 核心必须变量
export CV_SIMULATOR=xrun                    # 仿真器选择 (dsim|vcs|xrun|vsim|riviera)
export CV_CORE=cv32e40p                     # 核心选择
export CV_SW_TOOLCHAIN=/opt/riscv           # RISC-V工具链路径
export CV_SW_PREFIX=riscv32-unknown-elf-    # 工具链前缀

# 🔹 项目路径变量 (自动检测)
export CORE_V_VERIF=$(pwd)
export CV32E40P_UVMT_PATH=$CORE_V_VERIF/cv32e40p/sim/uvmt

# 🔹 可选优化变量
export CV_SIMULATOR_ARGS="+nc64bit +access+rw"  # Xcelium优化参数
export UVM_VERBOSITY=UVM_MEDIUM                  # UVM日志级别

# 🔹 验证环境设置
echo "✅ CV32E40P环境配置完成:"
echo "   仿真器: $CV_SIMULATOR"
echo "   工具链: $CV_SW_TOOLCHAIN"
echo "   项目路径: $CORE_V_VERIF"

# 🔹 快速环境检查
if [ ! -d "$CV_SW_TOOLCHAIN" ]; then
    echo "❌ 警告: 工具链路径不存在 $CV_SW_TOOLCHAIN"
    echo "   请修改CV_SW_TOOLCHAIN变量或安装RISC-V工具链"
fi

if command -v $CV_SIMULATOR &> /dev/null; then
    echo "✅ 仿真器 $CV_SIMULATOR 可用"
else
    echo "❌ 警告: 仿真器 $CV_SIMULATOR 未找到"
    echo "   请确保仿真器在PATH中或修改CV_SIMULATOR变量"
fi
```

**使用方法：**
```bash
# 在core-v-verif根目录下
source setup_cv32e40p.sh
```

### 📋 环境依赖检查清单

运行以下命令验证环境：

```bash
# 🔹 基本工具检查
which make          # Make工具
which python3       # Python3 (用于脚本)
which $CV_SIMULATOR # 仿真器

# 🔹 RISC-V工具链检查  
${CV_SW_PREFIX}gcc --version        # GCC编译器
${CV_SW_PREFIX}objdump --version    # 反汇编工具

# 🔹 项目结构检查
ls $CORE_V_VERIF/cv32e40p/sim/uvmt/Makefile  # 主Makefile
ls $CORE_V_VERIF/core-v-cores/cv32e40p       # RTL代码
```

---

## ✅ 第二步：平台验证 (10分钟)

### 🚀 运行第一个测试 - Hello World

```bash
# 进入CV32E40P测试目录
cd $CV32E40P_UVMT_PATH

# 运行hello-world测试
make test TEST=hello-world

# 预期结果: 
# - 编译成功，无错误
# - 仿真运行完成
# - 显示 "TEST PASSED" 或类似成功信息
```

**如果测试失败，请检查：**
```bash
# 🔹 检查编译日志
ls -la cv32e40p_* | head -5     # 查看生成的文件

# 🔹 检查仿真日志  
tail -50 cv32e40p_*.log         # 查看日志末尾

# 🔹 常见问题快速修复
make clean_all                  # 清理后重试
```

### 🎯 运行健全性测试

```bash
# 快速验证平台稳定性
make sanity

# 这将运行一组基本测试
# 预期时间: 2-5分钟
# 所有测试都应该PASS
```

### 📊 生成和查看波形

```bash
# 运行带波形的测试
make test TEST=hello-world WAVES=1

# 查看波形 (启动波形查看器)
make waves TEST=hello-world

# 注意: 需要配置GUI环境 (DISPLAY变量)
```

---

## 🛠️ 第三步：创建第一个自定义测试 (10分钟)

### 📁 创建测试目录结构

```bash
# 在自定义测试目录下创建新测试
cd $CORE_V_VERIF/cv32e40p/tests/programs/custom

# 创建自定义测试目录
mkdir my_first_test
cd my_first_test
```

### 📝 编写简单测试程序

创建 `my_first_test.c`:

```c
// my_first_test.c - 第一个自定义测试
#include <stdio.h>
#include <stdint.h>

// 简单的数学运算测试
int main() {
    printf("🚀 我的第一个CV32E40P测试开始!\n");
    
    // 🔹 基本运算测试
    int a = 42;
    int b = 13;
    int result = a + b;
    
    printf("计算: %d + %d = %d\n", a, b, result);
    
    // 🔹 简单循环测试
    int sum = 0;
    for(int i = 1; i <= 10; i++) {
        sum += i;
    }
    printf("1到10的和: %d\n", sum);
    
    // 🔹 条件分支测试
    if(sum == 55) {
        printf("✅ 测试PASSED - 计算正确!\n");
        return 0;  // 成功退出
    } else {
        printf("❌ 测试FAILED - 计算错误!\n");
        return 1;  // 失败退出
    }
}
```

### 🔧 创建Makefile

创建 `Makefile`:

```makefile
# my_first_test Makefile
TEST_NAME = my_first_test

# 包含项目的通用Makefile规则
include $(CORE_V_VERIF)/cv32e40p/tests/programs/custom/Common.mk

# 如果Common.mk不存在，使用基本规则:
$(TEST_NAME): $(TEST_NAME).c
	$(CV_SW_PREFIX)gcc -march=rv32imc -mabi=ilp32 -static -mcmodel=medany \
	-fvisibility=hidden -nostdlib -nostartfiles \
	-o $(TEST_NAME) $(TEST_NAME).c
```

### 🏃 运行自定义测试

```bash
# 返回到UVMT目录
cd $CV32E40P_UVMT_PATH

# 运行自定义测试
make test TEST=my_first_test

# 查看测试结果
grep -i "test.*passed\|test.*failed" cv32e40p_*.log
```

### 🔍 测试结果分析

**成功标志：**
```
[UVM] TEST PASSED
[RTL] Program execution completed successfully  
[LOG] 测试PASSED - 计算正确!
```

**失败调试：**
```bash
# 查看详细日志
tail -100 cv32e40p_*.log

# 检查程序编译
ls -la $CORE_V_VERIF/cv32e40p/tests/programs/custom/my_first_test/

# 重新清理编译
make clean_test TEST=my_first_test
make test TEST=my_first_test
```

---

## 📚 常用Make命令速查表

### 🔥 最常用命令

| 命令 | 功能 | 使用场景 |
|------|------|----------|
| `make test TEST=xxx` | 运行指定测试 | 日常测试 |
| `make sanity` | 快速健全性检查 | 环境验证 |
| `make clean_all` | 清理所有生成文件 | 重新开始 |
| `make waves TEST=xxx` | 查看波形 | 调试分析 |

### 🛠️ 高级命令

| 命令 | 功能 | 说明 |
|------|------|------|
| `make test TEST=xxx WAVES=1` | 运行测试并生成波形 | 调试必备 |
| `make test TEST=xxx COV=1` | 运行覆盖率测试 | 覆盖率分析 |
| `make test TEST=xxx GUI=1` | 交互式仿真 | 深度调试 |
| `make compliance RISCV_ISA=rv32i` | 运行合规测试 | 规范验证 |

### 🔧 参数定制

```bash
# 设置UVM详细级别
make test TEST=hello-world USER_RUN_FLAGS=+UVM_VERBOSITY=UVM_DEBUG

# 使用不同配置
make test TEST=hello-world CFG=pulp

# 指定仿真器参数
make test TEST=hello-world SIM_FLAGS="+define+MY_DEBUG"
```

---

## 🚨 快速故障排除

### ❌ 编译失败

**问题**: `make: *** No rule to make target`
```bash
# 解决方案
export CORE_V_VERIF=$(pwd)  # 重新设置项目路径
cd cv32e40p/sim/uvmt        # 确保在正确目录
```

**问题**: `riscv32-unknown-elf-gcc: command not found`
```bash
# 解决方案  
export CV_SW_TOOLCHAIN=/path/to/riscv    # 修正工具链路径
export PATH=$CV_SW_TOOLCHAIN/bin:$PATH   # 添加到PATH
```

### ❌ 仿真失败

**问题**: 仿真hang住不结束
```bash
# 强制停止仿真
kill -9 $(pgrep xrun)  # 或对应的仿真器进程

# 清理后重试
make clean_all
make test TEST=hello-world
```

**问题**: 找不到测试文件
```bash
# 检查测试是否存在
ls $CORE_V_VERIF/cv32e40p/tests/programs/custom/my_first_test/

# 重新编译测试程序
cd $CORE_V_VERIF/cv32e40p/tests/programs/custom/my_first_test/
make clean && make
```

### ❌ 权限问题

```bash
# 检查文件权限
ls -la cv32e40p_*

# 修复权限
chmod +x setup_cv32e40p.sh
```

---

## 🎉 成功验证清单

在继续进行复杂开发之前，请确保以下所有步骤都成功：

- [ ] ✅ 环境变量正确配置
- [ ] ✅ hello-world测试通过
- [ ] ✅ sanity测试套件通过  
- [ ] ✅ 波形生成和查看正常
- [ ] ✅ 自定义测试创建和运行成功
- [ ] ✅ 能够分析测试日志和结果

---

## 🔗 下一步学习建议

完成这个快速上手指南后，建议按以下顺序深入学习：

1. **[02-测试开发实战手册](./02-测试开发实战手册.md)** - 学习更复杂的测试开发技巧
2. **[03-调试问题解决宝典](./03-调试问题解决宝典.md)** - 掌握系统化的调试方法
3. **[../02-代码分析/01-项目编码模式深度分析.md](../02-代码分析/01-项目编码模式深度分析.md)** - 理解项目代码组织

---

> 💡 **实战建议**  
> 不要只是阅读这个指南，请真正动手执行每一个步骤。遇到问题时，先尝试故障排除部分的解决方案，然后再寻求帮助。

> ⚡ **效率提示**  
> 将`setup_cv32e40p.sh`脚本加入你的shell配置文件(`.bashrc`或`.zshrc`)，这样每次打开终端就自动配置好环境。